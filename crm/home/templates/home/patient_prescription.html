{% extends 'home/base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Add Prescription for {{ patient.name }}</h2>

  <form method="post">
    {% csrf_token %}

    <div class="mb-3">
      <label for="id_chief_complaints" class="form-label">Chief Complaints</label>
      <textarea name="chief_complaints" id="id_chief_complaints" class="form-control" rows="3">{{ form.chief_complaints.value }}</textarea>
    </div>

    <div class="mb-3">
      <label for="id_investigation" class="form-label">Investigation</label>
      <textarea name="investigation" id="id_investigation" class="form-control" rows="3">{{ form.investigation.value }}</textarea>
    </div>

    <div class="mb-3">
      <label for="id_examination_findings" class="form-label">Examination Findings</label>
      <textarea name="examination_findings" id="id_examination_findings" class="form-control" rows="3">{{ form.examination_findings.value }}</textarea>
    </div>

    <div class="mb-3">
      <label for="id_diagnosis" class="form-label">Diagnosis</label>
      <textarea name="diagnosis" id="id_diagnosis" class="form-control" rows="3">{{ form.diagnosis.value }}</textarea>
    </div>

    <div class="mb-3">
      <label for="id_treatment_plan" class="form-label">Treatment Plan</label>
      <textarea name="treatment_plan" id="id_treatment_plan" class="form-control" rows="3">{{ form.treatment_plan.value }}</textarea>
    </div>

    <div class="mb-3">
      <label for="id_medications_select" class="form-label">Select Medications</label>
      <select multiple class="form-control" id="id_medications_select" onchange="updateSelectedMedications()">
        <option>ACEROZ-P TAB</option>
        <option>ACEROZ SP TAB</option>
        <option>AZX PLUS CAP</option>
        <option>CORWALK BR TAB</option>
        <option>CK2 DM TAB</option>
        <option>HICERIN GM TAB</option>
        <option>ETAP -90 TAB</option>
        <option>ETAP –P TAB</option>
        <option>LINOMAG 600 TAB</option>
        <option>MECOFUL FORTE</option>
        <option>RIGA DM TAB</option>
        <option>ROULET DSR CAP</option>
        <option>ROZITOL TAB</option>
        <option>RONAC GEL</option>
        <option>THIOKOL –ET TAB</option>
        <option>ZELCAL TAB</option>
        <option>ZELCAL SACHET</option>
        <option>ZECOBAL P TAB</option>
      </select>
    </div>

    <!-- Selected medicines with dosage dropdowns -->
    <div id="selected-medications-container" class="mb-3">
      <!-- JS will dynamically add selected meds and dosage dropdowns here -->
    </div>

    <!-- Custom Medications -->
    <div class="mb-3">
      <label for="id_medications" class="form-label">Custom Medications (if not in list)</label>
      <textarea name="custom_medications" id="id_medications" class="form-control" rows="3">{{ form.medications.value }}</textarea>
    </div>

    <!-- Other fields -->
    <div class="mb-3">
      <label for="id_advice" class="form-label">Advice</label>
      <textarea name="advice" id="id_advice" class="form-control" rows="3">{{ form.advice.value }}</textarea>
    </div>

    <div class="mb-3">
      <label for="id_next_visit_date" class="form-label">Next Visit Date</label>
      <input type="date" name="next_visit_date" id="id_next_visit_date" class="form-control" value="{{ form.next_visit_date.value }}">
    </div>

    <button type="submit" class="btn btn-success">Save & Mark Done</button>
  </form>
</div>

<script>
  function updateSelectedMedications() {
    const select = document.getElementById('id_medications_select');
    const container = document.getElementById('selected-medications-container');

    // Get all selected options
    const selectedMeds = Array.from(select.selectedOptions).map(opt => opt.value);

    // Clear container
    container.innerHTML = '';

    selectedMeds.forEach((med, index) => {
      // Safe ID for elements
      const safeId = med.replace(/\s+/g, '_').replace(/[^\w]/g, '');

      // Create div for this medicine and dosage select
      const medDiv = document.createElement('div');
      medDiv.className = 'mb-2 d-flex align-items-center gap-3';

      medDiv.innerHTML = `
        <div style="flex:1;">
          <label class="form-label" for="dosage_${safeId}">${med}</label>
        </div>
        <div style="flex:1;">
          <select name="dosages_${index}" id="dosage_${safeId}" class="form-select" required>
            <option value="once">Once a day</option>
            <option value="twice">Twice a day</option>
            <option value="thrice">Three times a day</option>
          </select>
        </div>
        <input type="hidden" name="medications_${index}" value="${med}">
      `;

      container.appendChild(medDiv);
    });
  }

  // Initialize on page load (in case some meds are pre-selected)
  document.addEventListener('DOMContentLoaded', () => {
    updateSelectedMedications();
  });
</script>

{% endblock %}
